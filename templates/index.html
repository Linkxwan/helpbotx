<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="static\\style.css">
    <link rel="icon" type="image/x-icon" href="/static/logo_b.png">
    <script src="static\\script.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>
    <title>–í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –ø–æ–º–æ—â–Ω–∏—Ü–∞</title>
</head>
<body>
    <div class="navbar">
        <div class="long-title">
            <h3 class="long-version">–í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –ø–æ–º–æ—â–Ω–∏—Ü–∞</h3>
            <h3 class="short-version">–í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –ø–æ–º–æ—â–Ω–∏—Ü–∞</h3>
        </div>
        <div class="hamburger-menu">
            <input id="menu__toggle" type="checkbox" />
            <label class="menu__btn" for="menu__toggle">
                <span></span>
            </label>

            <ul class="menu__box">
                <li><a class="menu__item" href="/">–ù–∞ –≥–ª–∞–≤–Ω—É—é</a></li>
                <li><a class="menu__item" href="https://intuit.kg/.kg/">–ú–£–ò–¢</a></li>
                <li><a class="menu__item" href="https://comtehno.kg/">–ö–û–ú–¢–ï–•–ù–û</a></li>
                <!-- <li><a class="menu__item" href="https://comtehno.kg/timetable/">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</a></li> -->
                <li><a class="menu__item" href="/chat">–ß–∞—Ç  <em>beta</em></a></li>
                <li><a class="menu__item" href="/clear_history" id="clear-history">–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</a></li>
                <li><a class="menu__item" href="/voice-mode">–†–µ–∂–∏–º —Ä–∞–∑–≥–æ–≤–æ—Ä–∞</a></li>
                <li><a class="menu__item" href="/info">–°–ø—Ä–∞–≤–∫–∏</a></li>
            </ul>
        </div>
    </div>
    <div class="content">
        <div id="chat-container">
            <div id="hello" class="chat-message-bot" {% if chat_history|length > 0 %}style='display: none;'{% endif %}>

                <span class="avatar">
                    <img src="/static/logo_b.png" alt="Avatar">
                    <!-- ^_^ -->
                </span>
                <div class="info-bot">
                    <!-- <div class="name-bot" id="name-bot">–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫</div> -->
                    <div id="introduction">
                        <p style="margin: 5px 0px;">–ü—Ä–∏–≤–µ—Ç! üòä</p>
                        <p style="margin: 5px 0px;">–Ø –≤—Å–µ–≥–¥–∞ –≥–æ—Ç–æ–≤–∞ –ø–æ–º–æ—á—å –≤–∞–º —Å –ª—é–±—ã–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏! üí°</p>
                        <ul style="margin: 5px 0px;">
                            <li>–ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å —Å –∑–∞–¥–∞—á–µ–π? üß†</li>
                            <li>–ß—Ç–æ-—Ç–æ –ø–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—é? üë©‚Äçüíª</li>
                            <li>–ò–ª–∏, –º–æ–∂–µ—Ç –±—ã—Ç—å, –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å? üîç</li>
                        </ul>
                        <p style="margin: 5px 0px;">–Ø –≤—Å–µ–≥–¥–∞ —Ä—è–¥–æ–º, –Ω–µ —Å—Ç–µ—Å–Ω—è–π—Ç–µ—Å—å –æ–±—Ä–∞—â–∞—Ç—å—Å—è! üôå</p>
                    </div>
                </div>
            </div>
            {% for message in chat_history %}
                {% set index = loop.index0 %}
                {% if message.role == "user" %}
                    <div class="chat-message-user">
                        <div class="info-user">
                            <div class="message-content for-user" id="user-message-{{ index }}">{{ message.content | safe }}</div>
                        </div>
                    </div>
                {% else %}
                    <div class="chat-message-bot">
                        <span class="avatar">
                            <img src="static\\logo_b.png" alt="Avatar">
                        </span>
                        <div class="info-bot">
                            <!-- <div class="name-bot">^_^</div> -->
                            <div class="message-content" id="assistant-message-{{ index }}">{{ message.content | safe }}</div>
                            <div class="info {% if index == message_count - 1 %}last{% endif %}">
                                <audio id="myAudio" style="display: none;" controls>
                                    <source id="audioSource" type="audio/mpeg">
                                    –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —ç–ª–µ–º–µ–Ω—Ç audio.
                                </audio>
                                <div class="wrap-svg {% if index == message_count - 1 %}last{% endif %}">
                                    <svg fill="#d1d5db" width="20px" height="20px" viewBox="0 0 24 24" id="sound" data-name="Line Color" xmlns="http://www.w3.org/2000/svg" class="icon line-color" stroke="#d1d5db" onclick="sendSynthesisRequest('{{ index }}')">
                                        <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                                        <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                                        <g id="SVGRepo_iconCarrier">
                                            <path id="secondary" d="M18.36,5.64a9,9,0,0,1,0,12.72" style="fill: none; stroke: #d1d5db; stroke-linecap: round; stroke-linejoin: round; stroke-width: 2;"></path>
                                            <path id="secondary-2" data-name="secondary" d="M15.54,8.46a5,5,0,0,1,0,7.08" style="fill: none; stroke: #d1d5db; stroke-linecap: round; stroke-linejoin: round; stroke-width: 2;"></path>
                                            <path id="primary" d="M11,5V19L7,15H4a1,1,0,0,1-1-1V10A1,1,0,0,1,4,9H7Z" style="fill: none; stroke: #d1d5db; stroke-linecap: round; stroke-linejoin: round; stroke-width: 2;"></path>
                                        </g>
                                    </svg>
                                    <svg fill="#d1d5db" height="20px" width="20px" version="1.1" id="copy-button" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="-46 -46 552.00 552.00" xml:space="preserve" stroke="#d1d5db" stroke-width="0.0046" transform="rotate(0)" onclick="copyText('{{ index }}')">
                                        <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                                        <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round" stroke="#CCCCCC" stroke-width="0.9200000000000002"></g>
                                        <g id="SVGRepo_iconCarrier"> <g> <g> <g>
                                            <path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272 c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729 c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path>
                                            <path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272 c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068 c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001 C291.206,428.715,289.92,430,288.341,430z"></path></g> </g> </g>
                                        </g>
                                    </svg>
                                    <svg fill="#d1d5db" width="20px" height="20px" viewBox="0 0 1024.00 1024.00" id="bad_answer" xmlns="http://www.w3.org/2000/svg" class="icon" transform="rotate(0)matrix(-1, 0, 0, 1, 0, 0)" onclick="bad_answer('{{ index }}')">
                                        <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                                        <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                                        <g id="SVGRepo_iconCarrier">
                                            <path d="M885.9 490.3c3.6-12 5.4-24.4 5.4-37 0-28.3-9.3-55.5-26.1-77.7 3.6-12 5.4-24.4 5.4-37 0-28.3-9.3-55.5-26.1-77.7 3.6-12 5.4-24.4 5.4-37 0-51.6-30.7-98.1-78.3-118.4a66.1 66.1 0 0 0-26.5-5.4H144c-17.7 0-32 14.3-32 32v364c0 17.7 14.3 32 32 32h129.3l85.8 310.8C372.9 889 418.9 924 470.9 924c29.7 0 57.4-11.8 77.9-33.4 20.5-21.5 31-49.7 29.5-79.4l-6-122.9h239.9c12.1 0 23.9-3.2 34.3-9.3 40.4-23.5 65.5-66.1 65.5-111 0-28.3-9.3-55.5-26.1-77.7zM184 456V172h81v284h-81zm627.2 160.4H496.8l9.6 198.4c.6 11.9-4.7 23.1-14.6 30.5-6.1 4.5-13.6 6.8-21.1 6.7a44.28 44.28 0 0 1-42.2-32.3L329 459.2V172h415.4a56.85 56.85 0 0 1 33.6 51.8c0 9.7-2.3 18.9-6.9 27.3l-13.9 25.4 21.9 19a56.76 56.76 0 0 1 19.6 43c0 9.7-2.3 18.9-6.9 27.3l-13.9 25.4 21.9 19a56.76 56.76 0 0 1 19.6 43c0 9.7-2.3 18.9-6.9 27.3l-14 25.5 21.9 19a56.76 56.76 0 0 1 19.6 43c0 19.1-11 37.5-28.8 48.4z"></path>
                                        </g>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>
    <div class="presentation{% if chat_history|length > 0 %} hidden{% endif %}">
        <div class="blok one visible" onclick="sendQuestion('–ö–∞–∫–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ –µ—Å—Ç—å –≤ –∫–æ–ª–ª–µ–¥–∂–µ?')">
            <p class="bold-blok"><b>–ö–∞–∫–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</b><br> –µ—Å—Ç—å –≤ –∫–æ–ª–ª–µ–¥–∂–µ?</p>
            <div class="svg">
                <svg width="24" height="24" viewBox="0 -2 24 24" fill="#232323">
                    <path d="M12 6V18M12 6L7 11M12 6L17 11" stroke="#232323" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
            </div>
        </div>
        <div class="blok two" onclick="sendQuestion('–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –≤ —ç—Ç–æ–º —É—á–µ–±–Ω–æ–º –≥–æ–¥—É –∫–æ–Ω—Ç—Ä–∞–∫—Ç?')">
            <p class="bold-blok"><b>–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç </b><br>–≤ —ç—Ç–æ–º —É—á–µ–±–Ω–æ–º –≥–æ–¥—É –∫–æ–Ω—Ç—Ä–∞–∫—Ç?</p>
            <div class="svg">
                <svg width="24" height="24" viewBox="0 -2 24 24" fill="#232323">
                    <path d="M12 6V18M12 6L7 11M12 6L17 11" stroke="#232323" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
            </div>
        </div>
        <div class="blok three visible" onclick="sendQuestion('–ö–∞–∫ —Å–≤—è–∑–∞—Ç—Å—è —Å –ø—Ä–∏–µ–º–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–µ–π?')">
            <p class="bold-blok"><b>–ü—Ä–∏–µ–º–Ω–∞—è –∫–æ–º–∏—Å—Å–∏—è</b><br> –Ω–æ–º–µ—Ä Whatsapp</p>
            <div class="svg">
                <svg width="24" height="24" viewBox="0 -2 24 24" fill="#232323">
                    <path d="M12 6V18M12 6L7 11M12 6L17 11" stroke="#232323" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
            </div>
        </div>
        <div class="blok four" onclick="sendQuestion('–ö–∞–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –ø–æ–¥–∞—Ç—å –ø—Ä–∏ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–∏?')">
            <p class="bold-blok"><b>–ö–∞–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã </b><br> –ø–æ–¥–∞—Ç—å –ø—Ä–∏ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–∏?</p>
            <div class="svg">
                <svg width="24" height="24" viewBox="0 -2 24 24" fill="#232323">
                    <path d="M12 6V18M12 6L7 11M12 6L17 11" stroke="#232323" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
            </div>
        </div>
    </div>
    <div id="copy-notification" style="display: none;">–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!</div>
    <form id="chat-form" autocomplete="off">
        <div class="wrap-chat">
            <div class="chat-input">
                <textarea name="question" id="question-input" placeholder="–°–ø—Ä–æ—Å–∏—Ç—å —á—Ç–æ-–Ω–∏–±—É–¥—å..." rows="1" autofocus></textarea>
                <button type="button" id="voice-button" class="voice-button">
                    <svg width="24" height="24" viewBox="0 -2 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9.5 4C8.67157 4 8 4.67157 8 5.5V18.5C8 19.3284 8.67157 20 9.5 20C10.3284 20 11 19.3284 11 18.5V5.5C11 4.67157 10.3284 4 9.5 4Z" fill="#232323"></path>
                        <path d="M13 8.5C13 7.67157 13.6716 7 14.5 7C15.3284 7 16 7.67157 16 8.5V15.5C16 16.3284 15.3284 17 14.5 17C13.6716 17 13 16.3284 13 15.5V8.5Z" fill="#232323"></path>
                        <path d="M4.5 9C3.67157 9 3 9.67157 3 10.5V13.5C3 14.3284 3.67157 15 4.5 15C5.32843 15 6 14.3284 6 13.5V10.5C6 9.67157 5.32843 9 4.5 9Z" fill="#232323"></path>
                        <path d="M19.5 9C18.6716 9 18 9.67157 18 10.5V13.5C18 14.3284 18.6716 15 19.5 15C20.3284 15 21 14.3284 21 13.5V10.5C21 9.67157 20.3284 9 19.5 9Z" fill="#232323"></path>
                    </svg>
                </button>
                <button type="submit" id="send-button" class="send-button" style="display: none;">
                    <svg width="24" height="24" viewBox="0 -2 24 24" fill="#232323"> 
                        <path d="M12 6V18M12 6L7 11M12 6L17 11" stroke="#232323" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                    </svg>
                </button>
            </div>
        </div>
    </form>

    <div id="container">
        <div class="gooey" id="gooeyAnimation"></div>
        <svg id="bubble" width="200" height="200" xmlns="http://www.w3.org/2000/svg" filter="url(#goo)">
            <defs>
            <filter id="goo">
                <feGaussianBlur in="SourceGraphic" stdDeviation="10" result="blur" />
                <feColorMatrix in="blur" mode="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 19 -9" result="goo" />
                <feComposite in="SourceGraphic" in2="goo" operator="atop"/>
            </filter>
            </defs>
            <g>
            <circle id="bubble_4" r="50" cy="95" cx="100">
                <animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 100 100" to="360 100 100" dur="1s" repeatCount="indefinite"/>
            </circle>
            <circle id="bubble_3" r="50" cy="105" cx="100">
                <animateTransform attributeType="xml" attributeName="transform" type="rotate" from="360 105 100" to="0 105 100" dur="2s" repeatCount="indefinite"/>
            </circle>
            <circle id="bubble_2" r="50" cy="100" cx="95">
                <animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 100 95" to="360 100 95" dur="3s" repeatCount="indefinite"/>
            </circle>
            <circle id="bubble_1" r="50" cy="100" cx="105">
                <animateTransform attributeType="xml" attributeName="transform" type="rotate" from="360 100 105" to="0 100 105" dur="2.5s" repeatCount="indefinite"/>
            </circle>
            </g>
        
        </svg>
        
            <!-- –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –Ω–∞–¥ bubble -->
            <!-- –°–æ–æ–±—â–µ–Ω–∏–µ "–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å" -->
            <div id="startMessage">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</div>
            <div id="faceMessage" style="opacity: 0;">‚âß‚ó°‚â¶</div>
                
            <!-- –°–æ–æ–±—â–µ–Ω–∏–µ "–°–ª—É—à–∞—é..." -->
            <div id="listenMessage" style="display: none;">
                –°–ª—É—à–∞—é
                <div class="dots-container">
                    <span>.</span>
                    <span>.</span>
                    <span>.</span>
                </div>
            </div>
        
            <!-- –°–æ–æ–±—â–µ–Ω–∏–µ "–î—É–º–∞—é..." -->
            <div id="thinkingMessage" style="display: none;">
                –î—É–º–∞—é
                <div class="dots-container">
                    <span>.</span>
                    <span>.</span>
                    <span>.</span>
                </div>
            </div>

            <div id="exitButton">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g id="style=bulk"> <g id="close-circle"> <path id="vector (Stroke)" fill-rule="evenodd" clip-rule="evenodd" d="M1.25 12C1.25 6.06294 6.06294 1.25 12 1.25C17.9371 1.25 22.75 6.06294 22.75 12C22.75 17.9371 17.9371 22.75 12 22.75C6.06294 22.75 1.25 17.9371 1.25 12Z" fill="#BFBFBF"></path> <path id="vector (Stroke)_2" fill-rule="evenodd" clip-rule="evenodd" d="M8.46967 8.46967C8.76257 8.17678 9.23744 8.17678 9.53033 8.46967L15.5303 14.4697C15.8232 14.7626 15.8232 15.2374 15.5303 15.5303C15.2374 15.8232 14.7625 15.8232 14.4696 15.5303L8.46967 9.53033C8.17678 9.23743 8.17678 8.76256 8.46967 8.46967Z" fill="#000000"></path> <path id="vector (Stroke)_3" fill-rule="evenodd" clip-rule="evenodd" d="M15.5303 8.46967C15.8232 8.76257 15.8232 9.23744 15.5303 9.53033L9.53033 15.5303C9.23743 15.8232 8.76256 15.8232 8.46967 15.5303C8.17678 15.2374 8.17678 14.7625 8.46967 14.4696L14.4697 8.46967C14.7626 8.17678 15.2374 8.17678 15.5303 8.46967Z" fill="#000000"></path> </g> </g> </g></svg>
            </div>
        
        </div>
        <audio style="display: none;" id="audioPlayer" controls></audio>

    <script>  
// –°–æ—Ö—Ä–∞–Ω—è–µ–º —à–∏—Ä–∏–Ω—É —ç–∫—Ä–∞–Ω–∞ –≤ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
const initialVisibleWidth = document.documentElement.clientWidth;
console.log(initialVisibleWidth);

document.addEventListener("DOMContentLoaded", function () {
            const form = document.getElementById("chat-form");
            const input = document.getElementById("question-input");
            const voiceButton = document.getElementById('voice-button');
            const sendButton = document.getElementById('send-button');
            const chatContainer = document.getElementById("chat-container");
            const container = document.getElementById("container");

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–∂–¥—É –∫–Ω–æ–ø–∫–∞–º–∏
            function toggleButton() {
                if (input.value.trim() === "") {
                    voiceButton.style.display = 'block';
                    sendButton.style.display = 'none';
                } else {
                    voiceButton.style.display = 'none';
                    sendButton.style.display = 'block';
                }
            }
            
            // –í–∫–ª—é—á–∞–µ–º –≥–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥
            voiceButton.addEventListener('click', function() {
                // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å API –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä, Web Speech API.
                console.log("–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω");
                container.classList.toggle('blurred');  // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–ª–∞—Å—Å —Ä–∞–∑–º—ã—Ç–∏—è
                container.classList.toggle('visible');  // –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            });

            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞ –≤ –ø–æ–ª–µ
            input.addEventListener('input', toggleButton);

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
            // toggleButton();

            // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
            function addMessage(role, content, isThinking = false) {
    const messages = chatContainer.querySelectorAll(".chat-message-user, .chat-message-bot");
    messages.forEach(msg => msg.querySelector(".info")?.classList.remove("last")); // –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–π last

    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤–Ω–∏–∑
    window.scrollTo({
        top: document.body.scrollHeight,
        behavior: 'smooth',
        block: 'end'
    });

    // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç presentation –≤–Ω—É—Ç—Ä–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Å–æ–±—ã—Ç–∏—è, —á—Ç–æ–±—ã –æ–Ω –±—ã–ª –¥–æ—Å—Ç—É–ø–µ–Ω
    const presentation = document.querySelector('.presentation');
    const hello = document.getElementById('hello');

    // –ï—Å–ª–∏ presentation –Ω–µ –Ω–∞–π–¥–µ–Ω, —ç—Ç–æ –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –æ—à–∏–±–∫—É
    if (!presentation) {
        console.error("–≠–ª–µ–º–µ–Ω—Ç presentation –Ω–µ –Ω–∞–π–¥–µ–Ω.");
        return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω
    }

    const messageIndex = messages.length; // –ù–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å
    const messageDiv = document.createElement("div");
    messageDiv.classList.add(role === "user" ? "chat-message-user" : "chat-message-bot");

    if (role === "user") {
        messageDiv.innerHTML = `
            <div class="info-user">
                <div class="message-content for-user" id="user-message-${messageIndex}">${content}</div>
            </div>`;
    } else {
        messageDiv.innerHTML = `
            <span class="avatar">
                <img src="static\\logo_b.png" alt="Avatar">
            </span>
            <div class="info-bot">
                
                <div class="message-content" id="assistant-message-${messageIndex}">
                    <div class="loader">
                        <span class="loader__element"></span>
                        <span class="loader__element"></span>
                        <span class="loader__element"></span>
                    </div>
                </div>
                <div class="info last" id="message-info-${messageIndex}">
                    <audio id="myAudio" style="display: none;" controls>
                        <source id="audioSource" type="audio/mpeg">
                        –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —ç–ª–µ–º–µ–Ω—Ç audio.
                    </audio>
                    <div class="wrap-svg last">
                        <svg fill="#d1d5db" width="20px" height="20px" viewBox="0 0 24 24" id="sound" data-name="Line Color" xmlns="http://www.w3.org/2000/svg" class="icon line-color" stroke="#d1d5db" onclick="sendSynthesisRequest('${messageIndex}')">
                            <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                            <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                            <g id="SVGRepo_iconCarrier">
                                <path id="secondary" d="M18.36,5.64a9,9,0,0,1,0,12.72" style="fill: none; stroke: #d1d5db; stroke-linecap: round; stroke-linejoin: round; stroke-width: 2;"></path>
                                <path id="secondary-2" data-name="secondary" d="M15.54,8.46a5,5,0,0,1,0,7.08" style="fill: none; stroke: #d1d5db; stroke-linecap: round; stroke-linejoin: round; stroke-width: 2;"></path>
                                <path id="primary" d="M11,5V19L7,15H4a1,1,0,0,1-1-1V10A1,1,0,0,1,4,9H7Z" style="fill: none; stroke: #d1d5db; stroke-linecap: round; stroke-linejoin: round; stroke-width: 2;"></path>
                            </g>
                        </svg>
                        <svg fill="#d1d5db" height="20px" width="20px" version="1.1" id="copy-button" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="-46 -46 552.00 552.00" xml:space="preserve" stroke="#d1d5db" stroke-width="0.0046" transform="rotate(0)" onclick="copyText('${messageIndex}')">
                            <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                            <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round" stroke="#CCCCCC" stroke-width="0.9200000000000002"></g>
                            <g id="SVGRepo_iconCarrier"> <g> <g> <g>
                                <path d="M425.934,0H171.662c-18.122,0-32.864,14.743-32.864,32.864v77.134h30V32.864c0-1.579,1.285-2.864,2.864-2.864h254.272 c1.579,0,2.864,1.285,2.864,2.864v254.272c0,1.58-1.285,2.865-2.864,2.865h-74.729v30h74.729 c18.121,0,32.864-14.743,32.864-32.865V32.864C458.797,14.743,444.055,0,425.934,0z"></path>
                                <path d="M288.339,139.998H34.068c-18.122,0-32.865,14.743-32.865,32.865v254.272C1.204,445.257,15.946,460,34.068,460h254.272 c18.122,0,32.865-14.743,32.865-32.864V172.863C321.206,154.741,306.461,139.998,288.339,139.998z M288.341,430H34.068 c-1.58,0-2.865-1.285-2.865-2.864V172.863c0-1.58,1.285-2.865,2.865-2.865h254.272c1.58,0,2.865,1.285,2.865,2.865v254.273h0.001 C291.206,428.715,289.92,430,288.341,430z"></path></g> </g> </g>
                            </g>
                        </svg>
                        <svg fill="#d1d5db" width="20px" height="20px" viewBox="0 0 1024.00 1024.00" id="bad_answer" xmlns="http://www.w3.org/2000/svg" class="icon" transform="rotate(0)matrix(-1, 0, 0, 1, 0, 0)" onclick="bad_answer('${messageIndex}')">
                            <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                            <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                            <g id="SVGRepo_iconCarrier">
                                <path d="M885.9 490.3c3.6-12 5.4-24.4 5.4-37 0-28.3-9.3-55.5-26.1-77.7 3.6-12 5.4-24.4 5.4-37 0-28.3-9.3-55.5-26.1-77.7 3.6-12 5.4-24.4 5.4-37 0-51.6-30.7-98.1-78.3-118.4a66.1 66.1 0 0 0-26.5-5.4H144c-17.7 0-32 14.3-32 32v364c0 17.7 14.3 32 32 32h129.3l85.8 310.8C372.9 889 418.9 924 470.9 924c29.7 0 57.4-11.8 77.9-33.4 20.5-21.5 31-49.7 29.5-79.4l-6-122.9h239.9c12.1 0 23.9-3.2 34.3-9.3 40.4-23.5 65.5-66.1 65.5-111 0-28.3-9.3-55.5-26.1-77.7zM184 456V172h81v284h-81zm627.2 160.4H496.8l9.6 198.4c.6 11.9-4.7 23.1-14.6 30.5-6.1 4.5-13.6 6.8-21.1 6.7a44.28 44.28 0 0 1-42.2-32.3L329 459.2V172h415.4a56.85 56.85 0 0 1 33.6 51.8c0 9.7-2.3 18.9-6.9 27.3l-13.9 25.4 21.9 19a56.76 56.76 0 0 1 19.6 43c0 9.7-2.3 18.9-6.9 27.3l-13.9 25.4 21.9 19a56.76 56.76 0 0 1 19.6 43c0 9.7-2.3 18.9-6.9 27.3l-14 25.5 21.9 19a56.76 56.76 0 0 1 19.6 43c0 19.1-11 37.5-28.8 48.4z"></path>
                            </g>
                        </svg>
                    </div>
                </div>
            </div>`;
    }
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
    if (messageIndex.length > 0) {
            presentation.classList.remove('hidden');
        } else {
            presentation.classList.add('hidden');
            hello.style.display = 'none';
        }


    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight; // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
    return messageIndex;
}

let isRequestInProgress = false;  // –§–ª–∞–≥, —á—Ç–æ–±—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
form.addEventListener("submit", async function (event) {
    event.preventDefault();
    
    // –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å —É–∂–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
    if (isRequestInProgress) return;

    let message = input.value.trim();
    if (!message) return;

    // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
    input.style.height = "24px";
    input.value = "";

    toggleButton();

    // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å last —É –≤—Å–µ—Ö –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    const wrapSvgElements = document.querySelectorAll(".wrap-svg");
    wrapSvgElements.forEach((el) => {
        el.classList.remove("last");
    });

    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    addMessage("user", message);

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏ –≤–º–µ—Å—Ç–æ —Ç–µ–∫—Å—Ç–∞
    let botMessageIndex = addMessage("bot", "", true);

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –≤ true, —á—Ç–æ–±—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É
    isRequestInProgress = true;
    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
    document.getElementById("send-button").disabled = true;

    let formData = new FormData();
    formData.append("question", message);

    let response = await fetch("/api", {
        method: "POST",
        body: formData
    });

    let data = await response.json();
    
    if (data.response) {
        let botMessageElement = document.getElementById(`assistant-message-${botMessageIndex}`);
        botMessageElement.innerHTML = data.response; // –ú–µ–Ω—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –Ω–∞ —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞
        // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        updateHighlightWidth();
    } else {
        document.getElementById(`assistant-message-${botMessageIndex}`).textContent = `–ü—Ä–∏–≤–µ—Ç! –û–π, —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫. –Ø –Ω–µ —Å–º–æ–≥–ª–∞ –Ω–∞–π—Ç–∏ –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞ –Ω–µ–º–Ω–æ–≥–æ –ø–æ–∑–∂–µ!`;
    }

    // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å last —É –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É
    const updatedWrapSvgElements = document.querySelectorAll(".wrap-svg");
    const lastWrapSvgElement = updatedWrapSvgElements[updatedWrapSvgElements.length - 1];
    lastWrapSvgElement.classList.add("last");  // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å last –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —ç–ª–µ–º–µ–Ω—Ç—É

    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤–Ω–∏–∑
    window.scrollTo({
        top: document.body.scrollHeight,
        behavior: "smooth"
    });

    // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
    isRequestInProgress = false;
    document.getElementById("send-button").disabled = false;
});


            // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter
            input.addEventListener("keydown", function (event) {
                if (event.key === "Enter" && !event.shiftKey) {
                    event.preventDefault();
                    form.dispatchEvent(new Event("submit"));
                }
            });
        });


// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —à–∏—Ä–∏–Ω—ã —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å –∫–ª–∞—Å—Å–æ–º .highlight
function updateHighlightWidth() {
    const highlights = document.querySelectorAll('.highlight'); // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å –∫–ª–∞—Å—Å–æ–º .highlight
    let visibleWidth = initialVisibleWidth; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é –≤–∏–¥–∏–º—É—é —à–∏—Ä–∏–Ω—É —ç–∫—Ä–∞–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

    // –ï—Å–ª–∏ –æ–∫–Ω–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å, —Ç–æ –±–µ—Ä—ë–º —Ç–µ–∫—É—â—É—é —Ä–µ–∞–ª—å–Ω—É—é –≤–∏–¥–∏–º—É—é —à–∏—Ä–∏–Ω—É —ç–∫—Ä–∞–Ω–∞ (–±–µ–∑ –ø–æ–ª–æ—Å –ø—Ä–æ–∫—Ä—É—Ç–∫–∏)
    if (document.documentElement.clientWidth !== initialVisibleWidth) {
        visibleWidth = document.documentElement.clientWidth;
    }
    
    console.log(visibleWidth);

    // –î–ª—è –∫–∞–∂–¥–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ .highlight —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É
    highlights.forEach((highlight) => {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É highlight –∫–∞–∫ 80% –æ—Ç —à–∏—Ä–∏–Ω—ã —ç–∫—Ä–∞–Ω–∞, –Ω–æ –Ω–µ –±–æ–ª–µ–µ 689px
        // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ 150px (–Ω–∞–ø—Ä–∏–º–µ—Ä)
        highlight.style.width = `${Math.min(visibleWidth * 0.8, 689)}px`;
        // –î–æ–±–∞–≤–∏–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —à–∏—Ä–∏–Ω—É –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        highlight.style.minWidth = '150px'; 
    });
}

// –í—ã–∑–æ–≤–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('load', updateHighlightWidth);

// –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
window.addEventListener('resize', updateHighlightWidth);




let isListening = false;
const gooeyElement = document.getElementById('gooeyAnimation');
const bubbleElement = document.getElementById('bubble');
const startMessage = document.getElementById('startMessage');
const listenMessage = document.getElementById('listenMessage');
const thinkingMessage = document.getElementById('thinkingMessage');
const faceMessage = document.getElementById('faceMessage');
const audioPlayer = document.getElementById("audioPlayer");

let audioContext, analyser, dataArray;

bubbleElement.addEventListener('click', (event) => {
    if (recognition && recognition.state !== "started") {
        bubbleElement.style.transform = "translate(-50%, -50%) scale(0.5)";
        gooeyElement.style.opacity = '1';
        bubbleElement.style.opacity = '0';
        startMessage.style.display = 'none';
        startRecording();
    }
});
const exitButton = document.getElementById('exitButton');
const container = document.getElementById("container");
// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ "exit"
exitButton.addEventListener('click', function() {
    if (isListening) {
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –∞–∫—Ç–∏–≤–Ω–æ
        recognition.stop();
        console.log("–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ");

        // –°–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–°–ª—É—à–∞—é" –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        listenMessage.style.display = 'none';
        faceMessage.style.opacity = '1';
        bubbleElement.style.transform = "translate(-50%, -50%) scale(1)";  // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—É–∑—ã—Ä—å
        gooeyElement.style.opacity = '0';  // –°–∫—Ä—ã—Ç—å —ç–ª–µ–º–µ–Ω—Ç Gooey
        bubbleElement.style.opacity = '1';  // –í–µ—Ä–Ω—É—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç—å –ø—É–∑—ã—Ä—è

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–ª–∞–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        isListening = false;
    } else {
        // –ï—Å–ª–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –Ω–µ –∞–∫—Ç–∏–≤–Ω–æ, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–ª–∞—Å—Å—ã –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        console.log("–ú–µ–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–∞–∑–º—ã—Ç–∏—è –∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏");
        container.classList.toggle('blurred');  // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–ª–∞—Å—Å —Ä–∞–∑–º—ã—Ç–∏—è
        container.classList.toggle('visible');  // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    }
});

let recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
recognition.lang = navigator.language || 'ru-RU';
recognition.continuous = false;
recognition.interimResults = false;

function startRecording() {
    listenMessage.style.display = 'block';
    faceMessage.style.opacity = '0';
    if (recognition && recognition.state !== "started") {
        try {
            recognition.start();  // –∑–∞–ø—É—Å–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
        } catch (error) {
            console.error("–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–æ:");
        }
    }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞—á–∞–ª–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
recognition.onstart = function() {
    console.log("–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –Ω–∞—á–∞—Ç–æ");
    isListening = true;  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –Ω–∞—á–∞—Ç–æ
};

// –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è –Ω–∞ –æ–∫–æ–Ω—á–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏
recognition.onend = function() {
    console.log("–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ");
    isListening = false;  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ

    listenMessage.style.display = 'none';
    faceMessage.style.opacity = '1';
    // thinkingMessage.style.display = 'none';
    bubbleElement.style.transform = "translate(-50%, -50%) scale(1)";  
    gooeyElement.style.opacity = '0';
    bubbleElement.style.opacity = '1';
};

recognition.onresult = async (event) => {
    let text = event.results[0][0].transcript;
    console.log("Recognized: ", text);

    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ –æ—á–∏—â–∞–µ–º –ø–ª–µ–µ—Ä –ø–µ—Ä–µ–¥ –Ω–æ–≤—ã–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º
    audioPlayer.pause();
    audioPlayer.currentTime = 0; // –°–±—Ä–æ—Å –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –Ω–∞—á–∞–ª–æ

    bubbleElement.style.transform = "translate(-50%, -50%) scale(1)";
    gooeyElement.style.opacity = '0';
    bubbleElement.style.opacity = '1';
    thinkingMessage.style.display = 'block';
    faceMessage.style.opacity = '1';

    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    addMessage("user", text);

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏ –≤–º–µ—Å—Ç–æ —Ç–µ–∫—Å—Ç–∞
    let botMessageIndex = addMessage("bot", "", true);

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –≤ true, —á—Ç–æ–±—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É
    isRequestInProgress = true;
    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
    document.getElementById("send-button").disabled = true;

    let response = await fetch(`/live?question=${encodeURIComponent(text)}`);
    let responseData = await response.json();

    let audioUrl = responseData.created_file;

    if (responseData.response) {
        let botMessageElement = document.getElementById(`assistant-message-${botMessageIndex}`);
        botMessageElement.innerHTML = responseData.response; // –ú–µ–Ω—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –Ω–∞ —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞
        // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        updateHighlightWidth();
    } else {
        document.getElementById(`assistant-message-${botMessageIndex}`).textContent = `–ü—Ä–∏–≤–µ—Ç! –û–π, —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫. –Ø –Ω–µ —Å–º–æ–≥–ª–∞ –Ω–∞–π—Ç–∏ –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞ –Ω–µ–º–Ω–æ–≥–æ –ø–æ–∑–∂–µ!`;
    }

    // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å last —É –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É
    const updatedWrapSvgElements = document.querySelectorAll(".wrap-svg");
    const lastWrapSvgElement = updatedWrapSvgElements[updatedWrapSvgElements.length - 1];
    lastWrapSvgElement.classList.add("last");  // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å last –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —ç–ª–µ–º–µ–Ω—Ç—É

    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤–Ω–∏–∑
    window.scrollTo({
        top: document.body.scrollHeight,
        behavior: "smooth"
    });

    // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
    isRequestInProgress = false;
    document.getElementById("send-button").disabled = false;

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∞—É–¥–∏–æ –∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º
    audioPlayer.src = audioUrl;
    audioPlayer.play();

    thinkingMessage.style.display = 'none';
    faceMessage.style.opacity = '0';
};

function setupAudioAnalysis() {
    if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        const source = audioContext.createMediaElementSource(audioPlayer);
        source.connect(analyser);
        analyser.connect(audioContext.destination);
        analyser.fftSize = 256;
        dataArray = new Uint8Array(analyser.frequencyBinCount);
    }
}

function animateBubble() {
    if (!analyser) return;
    analyser.getByteFrequencyData(dataArray);
    let avgFrequency = dataArray.reduce((a, b) => a + b, 0) / dataArray.length;
    let scale = 1 + (avgFrequency / 255) * 1.3;
    let scaleFace = 1 + (avgFrequency / 255) * 0.5;
    bubbleElement.style.transform = `translate(-50%, -50%) scale(${scale})`;
    // faceMessage.style.transform = `translate(-50%, -50%) scale(${scaleFace})`;
    // faceMessage.style.display = 'none';
    requestAnimationFrame(animateBubble);
}

audioPlayer.addEventListener("play", () => {
    setupAudioAnalysis();
    audioContext.resume();
    animateBubble();
});

audioPlayer.addEventListener("pause", () => {
    bubbleElement.style.transform = "translate(-50%, -50%) scale(1)";
});

audioPlayer.addEventListener("ended", () => {
    bubbleElement.style.transform = "translate(-50%, -50%) scale(0.5)";
    gooeyElement.style.opacity = '1';
    bubbleElement.style.opacity = '0';
    startRecording();
});
    </script>
<style>
    #container {
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 100%;
        height: 100%;
        overflow: visible;
        
        opacity: 0;  /* –ù–∞—á–∞–ª—å–Ω–∞—è –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å (–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–∫—Ä—ã—Ç) */
        pointer-events: none;  /* –û—Ç–∫–ª—é—á–∞–µ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º, –ø–æ–∫–∞ –æ–Ω —Å–∫—Ä—ã—Ç */
    }

    #container.visible {
        transition: background-color 0.2s ease, backdrop-filter 0.2s ease; /* –ü–ª–∞–≤–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ–æ–Ω–∞ –∏ —Ä–∞–∑–º—ã—Ç–∏—è */
        opacity: 1; /* –î–µ–ª–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–∏–¥–∏–º—ã–º */
        pointer-events: all;  /* –í–∫–ª—é—á–∞–µ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º, –∫–æ–≥–¥–∞ –æ–Ω –≤–∏–¥–∏–º */
    }
    
    #container.blurred {
        background-color: rgba(35, 35, 35, 0.3); /* –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω */
        backdrop-filter: blur(10px); /* –†–∞–∑–º—ã—Ç–∏–µ —Ñ–æ–Ω–∞ */
        -webkit-backdrop-filter: blur(10px); /* –î–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –Ω–∞ —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö Safari */
    }
    
    #bubble {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(1);
        width: 200px;
        height: 200px;
        transition: transform 0.5s ease, opacity 0.5s ease;
        overflow: visible;
        cursor: pointer;
    }
    
    #bubble circle {
        filter: url(#goo);
    }
    
    #bubble_1, #bubble_2, #bubble_3, #bubble_4 {
        fill: #e9f0f1;
        r: 50%;
    }
    
    .gooey {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 120px;
        height: 60px;
        transform: translate(-50%, -50%);
        -webkit-filter: url(#goo);
        filter: url(#goo);
        transition: transform 0.5s ease, opacity 0.1s ease;
        overflow: visible; 
        opacity: 0;
    }
    
    .gooey:after,
    .gooey:before {
        content: "";
        position: absolute;
        display: block;
        background: #fff;
        border-radius: 50%;
    }
    
    .gooey:before {
        margin: 6px;
        width: 48px; 
        height: 48px;
        animation: leftGoo 3s ease infinite;
    }
    
    .gooey:after {
        width: 60px; 
        height: 60px;
        margin-left: 60px;
        animation: rightGoo 3s ease infinite;
    }
    
    @keyframes leftGoo {
        50% {
        transform: translateX(60px);
        }
    }
    
    @keyframes rightGoo {
        50% {
        transform: translateX(-60px);
        }
    }
    
    .gooey.hidden {
        opacity: 0;
        pointer-events: none;
    }
    
    .bubble-animation.hidden {
        opacity: 0;
        pointer-events: none;
    }

    #exitButton {
        position: absolute;
        top: 90%;
        left: 50%;
        width: 50px;
        height: 50px;
        transform: translate(-50%, -50%) scale(1);
    }
    #exitButton:hover {
        transform: translate(-50%, -50%) scale(1.1);
    }

    #faceMessage {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(1);
        color: #232323;
        font-weight: bold;
        font-size: 36px;
        text-align: center;
        opacity: 1;
        transition: opacity 0.3s ease;
        cursor: pointer;
        pointer-events: none;
    }
    
    #startMessage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(1);
            color: #232323;
            font-weight: bold;
            text-align: center;
            opacity: 1;
            transition: opacity 0.3s ease;
            cursor: pointer;
            pointer-events: none;
        }
    
        #listenMessage, #thinkingMessage {
            position: absolute;
            top: 80%;
            left: 50%;
            transform: translate(-50%, -50%) scale(1);
            color: #e9f0f1;
            font-weight: bold;
            text-align: center;
            opacity: 1;
            transition: opacity 0.3s ease;
        }
    
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–æ—è–≤–ª–µ–Ω–∏—è —Ç–æ—á–µ–∫ */
        .dots-container {
            display: inline-block;
            font-size: 16px;
            margin-left: 0px;
        }
    
        .dots-container span {
            opacity: 0;
            animation: dotsAnimation 2s infinite;
        }
    
        .dots-container span:nth-child(1) {
            animation-delay: 0s;
        }
    
        .dots-container span:nth-child(2) {
            animation-delay: 0.5s;
        }
    
        .dots-container span:nth-child(3) {
            animation-delay: 1s;
        }
    
        @keyframes dotsAnimation {
            0% {
                opacity: 0;
            }
            50% {
                opacity: 1;
            }
            100% {
                opacity: 0;
            }
        }
</style>
</body>
</html>
