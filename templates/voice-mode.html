<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="static\\style.css">
    <link rel="icon" type="image/x-icon" href="/static/logo_b.png">
    <!-- <script src="static\\script.js" defer></script> -->
    <title>Виртуальная помощница</title>
</head>
<body>
    <div class="navbar">
        <div class="long-title">
            <h3 class="long-version" onclick="window.location.href='/'">Виртуальная помощница (≧◡≦)♡</h3>
            <h3 class="short-version">Виртуальная помощница</h3>
        </div>
        <div class="hamburger-menu">
            <input id="menu__toggle" type="checkbox" />
            <label class="menu__btn" for="menu__toggle">
                <span></span>
            </label>
            <ul class="menu__box">
                <li><a class="menu__item" href="/">На главную</a></li>
                <li><a class="menu__item" href="https://intuit.kg/.kg/">МУИТ</a></li>
                <li><a class="menu__item" href="https://comtehno.kg/">КОМТЕХНО</a></li>
                <li><a class="menu__item" href="/chat">Чат  <em>beta</em></a></li>
                <li><a class="menu__item" href="/clear_history" id="clear-history">Очистить историю</a></li>
                <li><a class="menu__item" href="/voice-mode">Режим разговора</a></li>
                <li><a class="menu__item" href="/info">Справки</a></li>
            </ul>
        </div>
    </div>
    <div class="content">
<style>
body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    height: 100vh;
    width: 100vw;
    background-color: #232323;
}

#container {
    margin: 0;
    padding: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 100%;
    height: 100%;
    overflow: visible;
}

#bubble {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(1);
    width: 200px;
    height: 200px;
    transition: transform 0.5s ease, opacity 0.5s ease;
    overflow: visible;
    cursor: pointer;
}

#bubble circle {
    filter: url(#goo);
}

#bubble_1, #bubble_2, #bubble_3, #bubble_4 {
    fill: #e9f0f1;
    r: 50%;
}

.gooey {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 120px;
    height: 60px;
    transform: translate(-50%, -50%);
    -webkit-filter: url(#goo);
    filter: url(#goo);
    transition: transform 0.5s ease, opacity 0.1s ease;
    overflow: visible; 
    opacity: 0;
}

.gooey:after,
.gooey:before {
    content: "";
    position: absolute;
    display: block;
    background: #fff;
    border-radius: 50%;
}

.gooey:before {
    margin: 6px;
    width: 48px; 
    height: 48px;
    animation: leftGoo 3s ease infinite;
}

.gooey:after {
    width: 60px; 
    height: 60px;
    margin-left: 60px;
    animation: rightGoo 3s ease infinite;
}

@keyframes leftGoo {
    50% {
    transform: translateX(60px);
    }
}

@keyframes rightGoo {
    50% {
    transform: translateX(-60px);
    }
}

.gooey.hidden {
    opacity: 0;
    pointer-events: none;
}

.bubble-animation.hidden {
    opacity: 0;
    pointer-events: none;
}

#exitButton {
    position: absolute;
    top: 90%;
    left: 50%;
    width: 50px;
    height: 50px;
    transform: translate(-50%, -50%) scale(1);
}
#exitButton:hover {
    transform: translate(-50%, -50%) scale(1.1);
}

#faceMessage {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(1);
    color: #232323;
    font-weight: bold;
    font-size: 36px;
    text-align: center;
    opacity: 1;
    transition: opacity 0.3s ease;
    cursor: pointer;
    pointer-events: none;
}

#startMessage {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(1);
        color: #232323;
        font-weight: bold;
        text-align: center;
        opacity: 1;
        transition: opacity 0.3s ease;
        cursor: pointer;
        pointer-events: none;
    }

    #listenMessage, #thinkingMessage {
        position: absolute;
        top: 80%;
        left: 50%;
        transform: translate(-50%, -50%) scale(1);
        color: #e9f0f1;
        font-weight: bold;
        text-align: center;
        opacity: 1;
        transition: opacity 0.3s ease;
    }

    /* Стили для анимации появления точек */
    .dots-container {
        display: inline-block;
        font-size: 16px;
        margin-left: 0px;
    }

    .dots-container span {
        opacity: 0;
        animation: dotsAnimation 2s infinite;
    }

    .dots-container span:nth-child(1) {
        animation-delay: 0s;
    }

    .dots-container span:nth-child(2) {
        animation-delay: 0.5s;
    }

    .dots-container span:nth-child(3) {
        animation-delay: 1s;
    }

    @keyframes dotsAnimation {
        0% {
            opacity: 0;
        }
        50% {
            opacity: 1;
        }
        100% {
            opacity: 0;
        }
    }
</style>
<div id="container">
<div class="gooey" id="gooeyAnimation"></div>
<svg id="bubble" width="200" height="200" xmlns="http://www.w3.org/2000/svg" filter="url(#goo)">
    <defs>
    <filter id="goo">
        <feGaussianBlur in="SourceGraphic" stdDeviation="10" result="blur" />
        <feColorMatrix in="blur" mode="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 19 -9" result="goo" />
        <feComposite in="SourceGraphic" in2="goo" operator="atop"/>
    </filter>
    </defs>
    <g>
    <circle id="bubble_4" r="50" cy="95" cx="100">
        <animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 100 100" to="360 100 100" dur="1s" repeatCount="indefinite"/>
    </circle>
    <circle id="bubble_3" r="50" cy="105" cx="100">
        <animateTransform attributeType="xml" attributeName="transform" type="rotate" from="360 105 100" to="0 105 100" dur="2s" repeatCount="indefinite"/>
    </circle>
    <circle id="bubble_2" r="50" cy="100" cx="95">
        <animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 100 95" to="360 100 95" dur="3s" repeatCount="indefinite"/>
    </circle>
    <circle id="bubble_1" r="50" cy="100" cx="105">
        <animateTransform attributeType="xml" attributeName="transform" type="rotate" from="360 100 105" to="0 100 105" dur="2.5s" repeatCount="indefinite"/>
    </circle>
    </g>

</svg>

    <!-- Добавляем текст над bubble -->
    <!-- Сообщение "Нажми, чтобы начать" -->
    <div id="startMessage">Нажми, чтобы начать</div>
    <div id="faceMessage" style="opacity: 0;">≧◡≦</div>
        
    <!-- Сообщение "Слушаю..." -->
    <div id="listenMessage" style="display: none;">
        Слушаю
        <div class="dots-container">
            <span>.</span>
            <span>.</span>
            <span>.</span>
        </div>
    </div>

    <!-- Сообщение "Думаю..." -->
    <div id="thinkingMessage" style="display: none;">
        Думаю
        <div class="dots-container">
            <span>.</span>
            <span>.</span>
            <span>.</span>
        </div>
    </div>

    <div id="exitButton" style="display: none;">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g id="style=bulk"> <g id="close-circle"> <path id="vector (Stroke)" fill-rule="evenodd" clip-rule="evenodd" d="M1.25 12C1.25 6.06294 6.06294 1.25 12 1.25C17.9371 1.25 22.75 6.06294 22.75 12C22.75 17.9371 17.9371 22.75 12 22.75C6.06294 22.75 1.25 17.9371 1.25 12Z" fill="#BFBFBF"></path> <path id="vector (Stroke)_2" fill-rule="evenodd" clip-rule="evenodd" d="M8.46967 8.46967C8.76257 8.17678 9.23744 8.17678 9.53033 8.46967L15.5303 14.4697C15.8232 14.7626 15.8232 15.2374 15.5303 15.5303C15.2374 15.8232 14.7625 15.8232 14.4696 15.5303L8.46967 9.53033C8.17678 9.23743 8.17678 8.76256 8.46967 8.46967Z" fill="#000000"></path> <path id="vector (Stroke)_3" fill-rule="evenodd" clip-rule="evenodd" d="M15.5303 8.46967C15.8232 8.76257 15.8232 9.23744 15.5303 9.53033L9.53033 15.5303C9.23743 15.8232 8.76256 15.8232 8.46967 15.5303C8.17678 15.2374 8.17678 14.7625 8.46967 14.4696L14.4697 8.46967C14.7626 8.17678 15.2374 8.17678 15.5303 8.46967Z" fill="#000000"></path> </g> </g> </g></svg>
    </div>

</div>
<audio style="display: none;" id="audioPlayer" controls></audio>

<script>
const gooeyElement = document.getElementById('gooeyAnimation');
const bubbleElement = document.getElementById('bubble');
const startMessage = document.getElementById('startMessage');
const listenMessage = document.getElementById('listenMessage');
const thinkingMessage = document.getElementById('thinkingMessage');
const faceMessage = document.getElementById('faceMessage');
const audioPlayer = document.getElementById("audioPlayer");

let audioContext, analyser, dataArray;

bubbleElement.addEventListener('click', (event) => {
    if (recognition && recognition.state !== "started") {
        bubbleElement.style.transform = "translate(-50%, -50%) scale(0.5)";
        gooeyElement.style.opacity = '1';
        bubbleElement.style.opacity = '0';
        startMessage.style.display = 'none';
        startRecording();
    }
});

let isListening = false;
const exitButton = document.getElementById('exitButton');
const container = document.getElementById("container");
// Обработчик события для кнопки "exit"
exitButton.addEventListener('click', function() {
    if (isListening) {
        // Останавливаем распознавание, если оно активно
        recognition.stop();
        console.log("Распознавание речи остановлено");

        // Скрываем сообщение "Слушаю" и восстанавливаем интерфейс
        listenMessage.style.display = 'none';
        faceMessage.style.opacity = '1';
        bubbleElement.style.transform = "translate(-50%, -50%) scale(1)";  // Восстановить пузырь
        gooeyElement.style.opacity = '0';  // Скрыть элемент Gooey
        bubbleElement.style.opacity = '1';  // Вернуть видимость пузыря

        // Обновляем флаг состояния
        isListening = false;
    }
});


let recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
recognition.lang = navigator.language || 'ru-RU';
recognition.continuous = false;
recognition.interimResults = false;

function startRecording() {
    exitButton.style.display = 'block';
    listenMessage.style.display = 'block';
    faceMessage.style.opacity = '0';
    if (recognition && recognition.state !== "started") {
        try {
            recognition.start();  // запуск распознавания
        } catch (error) {
            console.error("Распознавания речи уже запущено:");
        }
    }
}

// Обработчик начала распознавания
recognition.onstart = function() {
    console.log("Распознавание начато");
    isListening = true;  // Устанавливаем флаг, что распознавание начато
};

// Добавляем обработчик события на окончание записи
recognition.onend = function() {
    exitButton.style.display = 'none';

    listenMessage.style.display = 'none';
    faceMessage.style.opacity = '1';

    isListening = false;  // Устанавливаем флаг, что распознавание завершено

    // thinkingMessage.style.display = 'none';
    bubbleElement.style.transform = "translate(-50%, -50%) scale(1)";  
    gooeyElement.style.opacity = '0';
    bubbleElement.style.opacity = '1';
};

recognition.onresult = async (event) => {
    let text = event.results[0][0].transcript;
    console.log("Recognized: ", text);

    // Останавливаем и очищаем плеер перед новым воспроизведением
    audioPlayer.pause();
    audioPlayer.currentTime = 0; // Сброс времени на начало

    bubbleElement.style.transform = "translate(-50%, -50%) scale(1)";
    gooeyElement.style.opacity = '0';
    bubbleElement.style.opacity = '1';
    thinkingMessage.style.display = 'block';
    faceMessage.style.opacity = '1';

    let response = await fetch(`/live?question=${encodeURIComponent(text)}`);
    let responseData = await response.json();

    let audioUrl = responseData.created_file;

    

    // Устанавливаем новый источник аудио и воспроизводим
    audioPlayer.src = audioUrl;
    audioPlayer.play();

    thinkingMessage.style.display = 'none';
    faceMessage.style.opacity = '0';
};

function setupAudioAnalysis() {
    if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        const source = audioContext.createMediaElementSource(audioPlayer);
        source.connect(analyser);
        analyser.connect(audioContext.destination);
        analyser.fftSize = 256;
        dataArray = new Uint8Array(analyser.frequencyBinCount);
    }
}

function animateBubble() {
    if (!analyser) return;
    analyser.getByteFrequencyData(dataArray);
    let avgFrequency = dataArray.reduce((a, b) => a + b, 0) / dataArray.length;
    let scale = 1 + (avgFrequency / 255) * 1.3;
    let scaleFace = 1 + (avgFrequency / 255) * 0.5;
    bubbleElement.style.transform = `translate(-50%, -50%) scale(${scale})`;
    // faceMessage.style.transform = `translate(-50%, -50%) scale(${scaleFace})`;
    // faceMessage.style.display = 'none';
    requestAnimationFrame(animateBubble);
}

audioPlayer.addEventListener("play", () => {
    setupAudioAnalysis();
    audioContext.resume();
    animateBubble();
});

audioPlayer.addEventListener("pause", () => {
    bubbleElement.style.transform = "translate(-50%, -50%) scale(1)";
});

audioPlayer.addEventListener("ended", () => {
    bubbleElement.style.transform = "translate(-50%, -50%) scale(0.5)";
    gooeyElement.style.opacity = '1';
    bubbleElement.style.opacity = '0';
    startRecording();
});

</script>
    </div>
</body>
</html>
